---

include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml

.test-template:
  extends: .template
  before_script:
    - set -euo pipefail
    - docker info
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - apk update && apk upgrade
    - apk add --no-cache bash git make helm curl
    # Detect system architecture
    - ARCH=$(uname -m)
    - |
      if [ "$ARCH" = "aarch64" ]; then
        GOARCH="arm64"
      elif [ "$ARCH" = "x86_64" ]; then
        GOARCH="amd64"
      else
        echo "Unsupported architecture: $ARCH"
        exit 1
      fi
    - curl -sSL "https://go.dev/dl/go1.25.3.linux-${GOARCH}.tar.gz" -o go.tar.gz
    - tar -C /usr/local -xzf go.tar.gz
    - rm go.tar.gz
    - export PATH="/usr/local/go/bin:$PATH"
    - go env -w GOPRIVATE=github.com/SlinkyProject/*

test:
  stage: test
  extends: .test-template
  tags:
    - schedmd-slc
  script:
    - set -euo pipefail
    - apk update && apk upgrade
    - apk add --no-cache shellcheck shfmt pre-commit curl
    - pre-commit run --verbose --all-files --show-diff-on-failure
  coverage: /total:\s+\(statements\)\s+\d+.\d+%/
  artifacts:
    expire_in: 7 days
    paths:
      - cover.html

audit:
  stage: test
  extends: .test-template
  script:
    - make govulncheck
  allow_failure: true

secret_detection:
  stage: test
  allow_failure: false
  artifacts:
    when: on_failure
    expire_in: 7 days
    paths:
      - gl-secret-detection-report.json
